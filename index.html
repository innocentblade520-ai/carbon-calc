<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°å°ç¢³è¶³è·¡ç²¾ç®—å¸«ï¼šæ‹¯æ•‘åœ°çƒå¤§ä½œæˆ°</title>
<link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="ç¢³è¶³è·¡å¯¦é©—å®¤">
<link rel="apple-touch-icon" href="icon-192.png">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --main-green: #4CAF50; --light-green: #81C784; --danger: #FF7043; --bg: #E3F2FD; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .header { text-align: center; margin-bottom: 20px; color: #37474F; }
        .header h1 { margin: 0; font-size: 2.2rem; }
        .header p { margin: 5px 0 0 0; font-size: 1rem; opacity: 0.8; }
        
        /* æ§åˆ¶å€ */
        .controls { background: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; display: flex; gap: 15px; align-items: center; border: 2px solid #BBDEFB; }
        .control-group { display: flex; gap: 5px; }
        input { border: 2px solid #ddd; padding: 8px 12px; border-radius: 20px; width: 140px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--main-green); }
        button { padding: 10px 24px; border: none; border-radius: 25px; background: var(--main-green); color: white; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; display: flex; align-items: center; gap: 5px; box-shadow: 0 4px #2E7D32; transform: translateY(-2px); }
        button:active { transform: translateY(2px); box-shadow: 0 0px #2E7D32; }
        .btn-save { background: #2196F3; box-shadow: 0 4px #1565C0; }
        .btn-save:active { box-shadow: 0 0 #1565C0; }
        .btn-reset { background: #FF5722; box-shadow: 0 4px #E64A19; }
        .btn-reset:active { box-shadow: 0 0 #E64A19; }

        .main-layout { display: flex; gap: 25px; width: 1200px; max-width: 98%; align-items: stretch; }

        /* å·¦å´ï¼šå‹•ç•«èˆ‡æ•¸å€¼ */
        .display-panel { flex: 1; background: white; padding: 25px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; justify-content: space-between; border: 3px solid #C8E6C9; }
        
        /* é›™è…³è¸æ­¥å‹•ç•« */
        .foot-container { display: flex; gap: 40px; margin-top: 20px; height: 100px; }
        .foot { width: 50px; height: 80px; background: var(--main-green); border-radius: 40% 40% 50% 50%; position: relative; opacity: 0.9; box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
        .foot::before { content: ''; position: absolute; width: 15px; height: 18px; background: var(--main-green); border-radius: 50%; top: -10px; left: 5px; box-shadow: 18px -4px 0 var(--main-green), 34px 2px 0 var(--main-green); }
        
        @keyframes step { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-25px) rotate(5deg); } }
        .foot.left { animation: step var(--speed, 2s) infinite ease-in-out; }
        .foot.right { animation: step var(--speed, 2s) infinite ease-in-out; animation-delay: calc(var(--speed, 2s) / 2); }

        .score-wrap { text-align: center; margin: 20px 0; }
        #total-val { font-size: 3.5rem; font-weight: 900; color: var(--main-green); transition: color 0.5s; text-shadow: 2px 2px 0px #eee; }
        .unit { font-size: 1.1rem; color: #78909C; font-weight: bold; }

        /* ä¸­é–“ï¼šæ‹–æ”¾å€ */
        .drop-zone { flex: 1.8; min-height: 550px; border: 4px dashed #81C784; border-radius: 30px; background: #F1F8E9; padding: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 12px; position: relative; transition: 0.3s; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); }
        .drop-zone::before { content: "æŠŠæ´»å‹•æ¨™ç±¤æ‹–åˆ°é€™è£¡é–‹å§‹è¨ˆç®—ï¼"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #AED581; font-size: 1.6rem; font-weight: bold; pointer-events: none; z-index: 0; text-align: center; width: 80%; }
        .drop-zone.drag-over { background: #DCEDC8; border-color: #558B2F; transform: scale(1.02); }

        /* å³å´ï¼šçœŸå¯¦æ•¸æ“šæ¸…å–® */
        .list-panel { flex: 1; display: flex; flex-direction: column; gap: 12px; max-height: 600px; overflow-y: auto; padding-right: 5px; }
        .item { padding: 12px 15px; background: white; border-radius: 15px; cursor: grab; box-shadow: 0 4px 8px rgba(0,0,0,0.08); border-left: 8px solid var(--main-green); font-size: 1rem; font-weight: bold; color: #546E7A; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .item:hover { transform: translateX(-5px); }
        .item:active { cursor: grabbing; }
        .item.plus { border-left-color: var(--danger); color: #D84315; }
        .item span.val { background: #eee; padding: 4px 8px; border-radius: 10px; font-size: 0.9rem; }

        /* åº•éƒ¨ï¼šéŠæˆ²åŒ–æˆæœå±•ç¤ºå€ */
        .bottom-section { width: 1200px; max-width: 98%; margin-top: 30px; display: flex; gap: 25px; height: 350px; }
        
        .game-stage { flex: 2.5; background: linear-gradient(to bottom, #4FC3F7 60%, #81C784 60%); border-radius: 30px; border: 4px solid #29B6F6; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .stage-title { position: absolute; top: 15px; left: 20px; background: rgba(255,255,255,0.8); padding: 8px 15px; border-radius: 20px; font-weight: bold; color: #0277BD; z-index: 10; }

        /* éŠæˆ²å…ƒç´ ï¼šæ¨¹èˆ‡é›² */
        .element { position: absolute; font-size: 3rem; user-select: none; }
        .tree { bottom: -50px; animation: popUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; z-index: 5; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
        .cloud { top: 20px; opacity: 0; animation: floatIn 15s linear infinite, fadeIn 1s forwards; z-index: 2; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); }
        
        @keyframes popUp { to { bottom: 20px; } }
        @keyframes floatIn { from { transform: translateX(-100px); } to { transform: translateX(800px); } }
        @keyframes fadeIn { to { opacity: 0.9; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .history-box { flex: 1; background: white; padding: 20px; border-radius: 30px; overflow-y: auto; border: 3px solid #B0BEC5; }
        .history-box h3 { margin-top: 0; color: #455A64; text-align: center; }
        .history-item { padding: 10px; margin-bottom: 8px; background: #F5F5F5; border-radius: 12px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .result-badge { padding: 4px 10px; border-radius: 20px; color: white; font-weight: bold; }
        .bad-result { background: var(--danger); }
        .good-result { background: var(--main-green); }

    </style>
</head>
<body>

<div class="header">
    <h1>ğŸŒ å°å°ç¢³è¶³è·¡ç²¾ç®—å¸«ï¼šæ‹¯æ•‘åœ°çƒå¤§ä½œæˆ°</h1>
    <p>ä»»å‹™ï¼šç›¡é‡è®“ç¢³è¶³è·¡è®Šæˆè² çš„ï¼Œå¹«åœ°çƒç¨®æ›´å¤šæ¨¹ï¼</p>
</div>

<div class="controls">
    <div class="control-group">
        <input type="text" id="custom-name" placeholder="è‡ªè¨‚æ´»å‹•åç¨±">
        <input type="number" id="custom-val" placeholder="æ•¸å€¼ (kg)">
        <button onclick="addCustom()">â• æ–°å¢</button>
    </div>
    <button class="btn-save" onclick="saveAndReward()">âœ¨ è¨˜éŒ„ä¸¦é ˜å–çå‹µ/æ‡²ç½°</button>
    <button class="btn-reset" onclick="reset()">ğŸ”„ å…¨éƒ¨é‡ä¾†</button>
</div>

<div class="main-layout">
    <div class="display-panel">
        <h3 style="margin: 0; color: #546E7A;">ç›®å‰çš„ç¢³è¶³è·¡</h3>
        <div class="foot-container" id="foots">
            <div class="foot left"></div>
            <div class="foot right"></div>
        </div>
        <div class="score-wrap">
            <div id="total-val">0.000</div>
            <div class="unit">å…¬æ–¤äºŒæ°§åŒ–ç¢³ç•¶é‡ (kg COâ‚‚e)</div>
        </div>
        <div id="status-text" style="color:#90A4AE; font-weight: bold;">æº–å‚™é–‹å§‹è¨ˆç®—...</div>
    </div>

    <div id="dropzone" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)"></div>

    <div id="source-list" class="list-panel" ondragover="allowDrop(event)" ondrop="drop(event)">
        </div>
</div>

<div class="bottom-section">
    <div class="game-stage" id="game-stage">
        <div class="stage-title">ğŸŒ³ æˆ‘å€‘çš„åœ°çƒå®¶åœ’æˆæœå€</div>
        </div>

    <div class="history-box">
        <h3>ğŸ“‹ è¨˜éŒ„æ¿</h3>
        <div id="history-list"></div>
    </div>
</div>

<script>
    // ç°¡åŒ–å¾Œçš„çœŸå¯¦æ•¸æ“šï¼Œé©åˆä¸‰å¹´ç´šèªçŸ¥
    const realData = [
        { name: "å–ä¸€ç“¶å¯æ¨‚/æ²™å£«", val: 0.304 },
        { name: "å–ä¸€ç“¶ç“¶è£æ°´", val: 0.150 },
        { name: "åƒä¸€é¡†é›è›‹", val: 0.100 },
        { name: "åƒä¸€ç‰‡åå¸", val: 0.050 },
        { name: "ç”¨æ‰ä¸€åŒ…è¡›ç”Ÿç´™", val: 0.400 },
        { name: "é–‹å†·æ°£1å°æ™‚(ä¼°è¨ˆ)", val: 0.500 }, // ä¼°è¨ˆå€¼ç”¨æ–¼æ•™å­¸
        { name: "æ­çˆ¸çˆ¸çš„è»Šå»ä¸Šå­¸", val: 0.800 }, // ä¼°è¨ˆå€¼
        { name: "è¶…ç´šä¹–å¯¶å¯¶ï¼šè‡ªå‚™æ°´å£º", val: -0.200 }, // çå‹µå€¼æ”¾å¤§
        { name: "è¶…ç´šä¹–å¯¶å¯¶ï¼šè‡ªå‚™é¤å…·", val: -0.150 },
        { name: "è¶…ç´šä¹–å¯¶å¯¶ï¼šèµ°è·¯å»ä¸Šå­¸", val: -0.500 },
        { name: "å¹«å¿™åšè³‡æºå›æ”¶", val: -0.300 }
    ];

    let currentTotal = 0;
    let displayedTotal = 0;
    let historyCount = 0;

    // åˆå§‹åŒ–
    window.onload = () => {
        const list = document.getElementById('source-list');
        realData.forEach((d, i) => {
            const item = createItem(d.name, d.val, 'item-' + i);
            list.appendChild(item);
        });
        updateSpeed();
    };

    function createItem(name, val, id) {
        const div = document.createElement('div');
        div.className = `item ${val > 0 ? 'plus' : 'minus'}`;
        div.id = id;
        div.draggable = true;
        div.dataset.val = val;
        // ä½¿ç”¨ span åŒ…ä½æ•¸å€¼ä»¥ä¾¿æ¨£å¼èª¿æ•´
        div.innerHTML = `${name} <span class="val">${val > 0 ? '+' : ''}${val.toFixed(2)}</span>`;
        div.ondragstart = (e) => {
            e.dataTransfer.setData("text", e.target.id);
            e.target.style.opacity = '0.5';
        };
        div.ondragend = (e) => e.target.style.opacity = '1';
        return div;
    }

    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
    function leaveDrop(e) { e.currentTarget.classList.remove('drag-over'); }

    function drop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        const id = e.dataTransfer.getData("text");
        const el = document.getElementById(id);
        
        let target = e.target;
        while(target && !target.id) target = target.parentElement;
        
        if (target.id === "dropzone" || target.id === "source-list") {
            target.appendChild(el);
            calculate();
        }
    }

    function calculate() {
        const items = document.getElementById('dropzone').querySelectorAll('.item');
        currentTotal = Array.from(items).reduce((sum, item) => sum + parseFloat(item.dataset.val), 0);
        updateSpeed();
        animateValue();
    }

    // å¹³æ»‘æ•¸å€¼è·³å‹•
    function animateValue() {
        const step = (currentTotal - displayedTotal) / 8;
        if (Math.abs(step) > 0.001) {
            displayedTotal += step;
            document.getElementById('total-val').innerText = displayedTotal.toFixed(3);
            requestAnimationFrame(animateValue);
        } else {
            displayedTotal = currentTotal;
            document.getElementById('total-val').innerText = displayedTotal.toFixed(3);
        }
        
        const totalValEl = document.getElementById('total-val');
        const statusText = document.getElementById('status-text');
        if (currentTotal > 0.001) {
            totalValEl.style.color = '#FF7043'; // ç´…è‰²è­¦å‘Š
            statusText.innerText = "å–”å–”...ç¢³è¶³è·¡åœ¨å¢åŠ äº†!";
            statusText.style.color = '#FF7043';
        } else if (currentTotal < -0.001) {
            totalValEl.style.color = '#4CAF50'; // ç¶ è‰²çå‹µ
            statusText.innerText = "å¤ªæ£’äº†ï¼æ­£åœ¨å¹«åŠ©åœ°çƒé™æº«ï¼";
            statusText.style.color = '#4CAF50';
        } else {
            totalValEl.style.color = '#4CAF50';
            statusText.innerText = "æº–å‚™é–‹å§‹è¨ˆç®—...";
            statusText.style.color = '#90A4AE';
        }
    }

    // æ›´æ–°è¸æ­¥é€Ÿåº¦
    function updateSpeed() {
        const absVal = Math.abs(currentTotal);
        // é€Ÿåº¦ç¯„åœå¾ 2.5ç§’(æ…¢) åˆ° 0.3ç§’(å¿«)
        const speed = Math.max(0.3, 2.5 - (absVal * 0.8));
        document.getElementById('foots').style.setProperty('--speed', speed + 's');
    }

    function addCustom() {
        const name = document.getElementById('custom-name').value;
        const val = parseFloat(document.getElementById('custom-val').value);
        if (name && !isNaN(val)) {
            const item = createItem(name, val, 'custom-' + Date.now());
            document.getElementById('source-list').prepend(item);
             // æ¸…ç©ºè¼¸å…¥
             document.getElementById('custom-name').value = '';
             document.getElementById('custom-val').value = '';
        }
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šè¨˜éŒ„ä¸¦çµ¦äºˆéŠæˆ²åŒ–å›é¥‹
    function saveAndReward() {
        if (Math.abs(currentTotal) < 0.01) return; // æ•¸å€¼å¤ªå°ä¸è¨˜éŒ„

        historyCount++;
        const val = currentTotal.toFixed(3);
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const stage = document.getElementById('game-stage');
        
        // 1. æ›´æ–°æ­·å²åˆ—è¡¨
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        let resultBadge = '';
        
        // 2. æ ¹æ“šæ•¸å€¼åœ¨å ´æ™¯ä¸­æ·»åŠ å…ƒç´ 
        // è¨­å®šä¸€å€‹é–¾å€¼ï¼Œä¾‹å¦‚æ¯ 0.3kg ç”¢ç”Ÿä¸€å€‹å…ƒç´ 
        const threshold = 0.3;
        let count = Math.max(1, Math.floor(Math.abs(currentTotal) / threshold));
        // é™åˆ¶ä¸€æ¬¡æœ€å¤šç”¢ç”Ÿ 5 å€‹ï¼Œé¿å…ç•«é¢çˆ†ç‚¸
        count = Math.min(count, 5); 

        if (currentTotal > 0) {
            // å¢åŠ ç¢³è¶³è·¡ -> ç”¢ç”Ÿçƒé›²
            resultBadge = `<span class="result-badge bad-result">å¢åŠ  ${val} kg â˜ï¸</span>`;
            for(let i=0; i<count; i++) {
                addCloud(stage);
            }
            // è®“å ´æ™¯æ™ƒå‹•ä¸€ä¸‹è¡¨ç¤ºè­¦å‘Š
            stage.style.animation = 'shake 0.5s';
            setTimeout(() => stage.style.animation = '', 500);

        } else {
             // æ¸›å°‘ç¢³è¶³è·¡ -> ç”¢ç”Ÿæ¨¹æœ¨
            resultBadge = `<span class="result-badge good-result">æ¸›å°‘ ${val} kg ğŸŒ³</span>`;
            for(let i=0; i<count; i++) {
                addTree(stage);
            }
        }

        historyItem.innerHTML = `<span>#${historyCount} ${time}</span> ${resultBadge}`;
        document.getElementById('history-list').prepend(historyItem);
    }

    function addTree(stage) {
        const tree = document.createElement('div');
        tree.className = 'element tree';
        tree.innerText = ['ğŸŒ³', 'ğŸŒ²', 'ğŸŒ´'][Math.floor(Math.random()*3)]; // éš¨æ©Ÿæ¨¹ç¨®
        // éš¨æ©Ÿä½ç½®ï¼Œä½†è¦åœ¨è‰åœ°ä¸Š
        tree.style.left = (Math.random() * 80 + 10) + '%'; 
        tree.style.fontSize = (Math.random() * 1 + 2.5) + 'rem'; // éš¨æ©Ÿå¤§å°
        stage.appendChild(tree);
    }

    function addCloud(stage) {
        const cloud = document.createElement('div');
        cloud.className = 'element cloud';
        cloud.innerText = ['â˜ï¸', 'ğŸŒ«ï¸', 'ğŸŒ©ï¸'][Math.floor(Math.random()*3)]; // éš¨æ©Ÿé›²
        // éš¨æ©Ÿé«˜åº¦èˆ‡èµ·å§‹ä½ç½®
        cloud.style.top = (Math.random() * 40 + 5) + '%';
        cloud.style.left = - (Math.random() * 100 + 50) + 'px';
        // éš¨æ©Ÿé£„å‹•é€Ÿåº¦
        cloud.style.animationDuration = (Math.random() * 10 + 10) + 's';
        stage.appendChild(cloud);
    }

    function reset() {
        const zone = document.getElementById('dropzone');
        const list = document.getElementById('source-list');
        const stage = document.getElementById('game-stage');
        
        // æ¨™ç±¤æ­¸ä½
        while (zone.firstChild) list.appendChild(zone.firstChild);
        
        // æ¸…ç©ºéŠæˆ²å ´æ™¯
        const elements = stage.querySelectorAll('.element');
        elements.forEach(el => el.remove());

        calculate();
        // é‡ç½®æç¤ºæ–‡å­—
        document.getElementById('status-text').innerText = "æº–å‚™é–‹å§‹è¨ˆç®—...";
        document.getElementById('status-text').style.color = '#90A4AE';
    }
</script>
</body>
</html>