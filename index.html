<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°å°ç¢³è¶³è·¡ç²¾ç®—å¸« APP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        :root { --main-green: #4CAF50; --danger: #FF7043; --bg: #E3F2FD; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        .header { text-align: center; margin-bottom: 15px; width: 100%; }
        h1 { font-size: 1.5rem; margin: 10px 0; color: #37474F; }

        /* æ§åˆ¶å€ï¼šæ‰‹æ©Ÿç‰ˆè‡ªå‹•æ›è¡Œ */
        .controls { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; box-sizing: border-box; }
        input { border: 2px solid #ddd; padding: 8px; border-radius: 10px; width: 100px; }
        button { padding: 8px 15px; border: none; border-radius: 15px; background: var(--main-green); color: white; cursor: pointer; font-weight: bold; }
        .btn-save { background: #2196F3; }
        .btn-reset { background: #FF5722; }

        /* ä¸»ä½ˆå±€ï¼šæ‰‹æ©Ÿå‚ç›´ã€é›»è…¦æ°´å¹³ */
        .main-layout { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 1200px; }
        @media (min-width: 768px) { .main-layout { flex-direction: row; } }

        /* å·¦å´ï¼šè…³å°èˆ‡åˆ†æ•¸ */
        .display-panel { background: white; padding: 20px; border-radius: 25px; display: flex; flex-direction: column; align-items: center; border: 2px solid #C8E6C9; flex: 1; }
        .foot-container { display: flex; gap: 30px; height: 80px; align-items: flex-end; }
        .foot { width: 35px; height: 60px; background: var(--main-green); border-radius: 40% 40% 50% 50%; position: relative; opacity: 0.8; }
        .foot::before { content: ''; position: absolute; width: 10px; height: 12px; background: var(--main-green); border-radius: 50%; top: -8px; left: 4px; box-shadow: 12px -3px 0 var(--main-green), 24px 2px 0 var(--main-green); }
        
        @keyframes step { 0%, 100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(-20px); opacity: 1; } }
        .foot.left { animation: step var(--speed, 2s) infinite; }
        .foot.right { animation: step var(--speed, 2s) infinite; animation-delay: calc(var(--speed, 2s) / 2); }

        #total-val { font-size: 3rem; font-weight: 900; color: var(--main-green); margin: 10px 0; }

        /* ä¸­é–“ï¼šæ‹–æ”¾è¨ˆç®—å€ */
        .drop-zone { min-height: 250px; border: 3px dashed #81C784; border-radius: 25px; background: #F1F8E9; padding: 15px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; flex: 1.5; position: relative; }
        .drop-zone::after { content: "æ‹–åˆ°é€™è£¡è¨ˆç®—"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #AED581; font-weight: bold; pointer-events: none; }

        /* å³å´ï¼šæ´»å‹•æ¸…å–® */
        .list-panel { flex: 1; display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
        .item { padding: 10px; background: white; border-radius: 12px; cursor: grab; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 6px solid var(--main-green); font-size: 0.9rem; font-weight: bold; }
        .item.plus { border-left-color: var(--danger); }

        /* åº•éƒ¨ï¼šéŠæˆ²æˆæœå€ */
        .bottom-section { width: 100%; margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .game-stage { height: 200px; background: linear-gradient(to bottom, #4FC3F7 50%, #81C784 50%); border-radius: 20px; position: relative; overflow: hidden; border: 3px solid #29B6F6; }
        .element { position: absolute; font-size: 2rem; bottom: 10px; transition: 0.5s; }
        .cloud { top: 10px; bottom: auto; animation: float 10s linear infinite; }
        @keyframes float { from { left: -50px; } to { left: 110%; } }
        
        .history-box { background: white; padding: 15px; border-radius: 20px; max-height: 150px; overflow-y: auto; }
    </style>
</head>
    <script>
    // é€™æ®µæ˜¯è®“ç¶²é è®Šèº«æˆ APP çš„é—œéµæŒ‡ä»¤
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('APP è¨»å†ŠæˆåŠŸï¼', reg))
                .catch(err => console.log('è¨»å†Šå¤±æ•—', err));
        });
    }
</script>
<body>

<div class="header">
    <h1>ğŸŒ å°å°ç¢³è¶³è·¡ç²¾ç®—å¸«</h1>
</div>

<div class="controls">
    <input type="text" id="c-name" placeholder="åç¨±">
    <input type="number" id="c-val" placeholder="kg">
    <button onclick="addCustom()">â•æ–°å¢</button>
    <button class="btn-save" onclick="saveRecord()">âœ¨é ˜å–çå‹µ</button>
    <button class="btn-reset" onclick="reset()">ğŸ”„é‡ç½®</button>
</div>

<div class="main-layout">
    <div class="display-panel">
        <div class="foot-container" id="foots">
            <div class="foot left"></div>
            <div class="foot right"></div>
        </div>
        <div id="total-val">0.000</div>
        <div style="font-size: 0.8rem; color: #78909C;">kg COâ‚‚e</div>
    </div>

    <div id="dropzone" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)"></div>

    <div id="source-list" class="list-panel" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div class="item plus" draggable="true" ondragstart="drag(event)" id="d1" data-val="0.304">å–ç“¶è£æ±½æ°´ (+0.3)</div>
        <div class="item plus" draggable="true" ondragstart="drag(event)" id="d2" data-val="0.800">æ­æ±½è»Šä¸Šå­¸ (+0.8)</div>
        <div class="item plus" draggable="true" ondragstart="drag(event)" id="d3" data-val="0.400">ç”¨ä¸€åŒ…è¡›ç”Ÿç´™ (+0.4)</div>
        <div class="item minus" draggable="true" ondragstart="drag(event)" id="d4" data-val="-0.200">è‡ªå‚™æ°´å£º (-0.2)</div>
        <div class="item minus" draggable="true" ondragstart="drag(event)" id="d5" data-val="-0.500">èµ°è·¯å»ä¸Šå­¸ (-0.5)</div>
    </div>
</div>

<div class="bottom-section">
    <div class="game-stage" id="stage">
        <div style="padding: 10px; font-weight: bold; color: white;">ğŸŒ± åœ°çƒå®¶åœ’ç‹€æ…‹</div>
    </div>
    <div class="history-box" id="h-list"></div>
</div>

<script>
    let currentTotal = 0;
    let displayedTotal = 0;

    function drag(e) { e.dataTransfer.setData("text", e.target.id); }
    function allowDrop(e) { e.preventDefault(); }
    function drop(e) {
        e.preventDefault();
        const id = e.dataTransfer.getData("text");
        const el = document.getElementById(id);
        let target = e.target;
        while(target && !target.id) target = target.parentElement;
        if(target.id === 'dropzone' || target.id === 'source-list') {
            target.appendChild(el);
            calculate();
        }
    }

    function calculate() {
        const items = document.getElementById('dropzone').querySelectorAll('.item');
        currentTotal = Array.from(items).reduce((s, i) => s + parseFloat(i.dataset.val), 0);
        updateSpeed();
        animateValue();
    }

    function animateValue() {
        const step = (currentTotal - displayedTotal) / 10;
        if (Math.abs(step) > 0.001) {
            displayedTotal += step;
            document.getElementById('total-val').innerText = displayedTotal.toFixed(3);
            requestAnimationFrame(animateValue);
        } else {
            displayedTotal = currentTotal;
            document.getElementById('total-val').innerText = displayedTotal.toFixed(3);
        }
        document.getElementById('total-val').style.color = currentTotal > 0 ? '#FF7043' : '#4CAF50';
    }

    function updateSpeed() {
        const absVal = Math.abs(currentTotal);
        const speed = Math.max(0.2, 2.0 - (absVal * 1.5));
        document.getElementById('foots').style.setProperty('--speed', speed + 's');
    }

    function saveRecord() {
        const stage = document.getElementById('stage');
        const el = document.createElement('div');
        el.className = 'element';
        if(currentTotal < 0) {
            el.innerText = 'ğŸŒ³';
            el.style.left = Math.random() * 90 + '%';
            stage.appendChild(el);
        } else if(currentTotal > 0) {
            el.className = 'element cloud';
            el.innerText = 'â˜ï¸';
            el.style.top = Math.random() * 40 + 'px';
            stage.appendChild(el);
        }
        const h = document.createElement('div');
        h.innerText = `è¨˜éŒ„ï¼š${currentTotal.toFixed(3)} kg`;
        document.getElementById('h-list').prepend(h);
    }

    function addCustom() {
        const n = document.getElementById('c-name').value;
        const v = parseFloat(document.getElementById('c-val').value);
        if(n && !isNaN(v)) {
            const id = 'custom-' + Date.now();
            const div = document.createElement('div');
            div.className = `item ${v > 0 ? 'plus' : 'minus'}`;
            div.id = id; div.draggable = true; div.dataset.val = v;
            div.innerText = `${n} (${v > 0 ? '+' : ''}${v})`;
            div.ondragstart = drag;
            document.getElementById('source-list').prepend(div);
        }
    }

    function reset() { location.reload(); }

    // è¨»å†Š APP æ ¸å¿ƒåŠŸèƒ½
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js');
    }
</script>
</body>
</html>

